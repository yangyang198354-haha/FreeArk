@echo off
:: è®¾ç½®ä»£ç é¡µä¸ºUTF-8ä»¥æ”¯æŒä¸­æ–‡æ˜¾ç¤º
chcp 65001 >nul
setlocal enabledelayedexpansion

:: ========================================================
:: å¤šçº¿ç¨‹è¥¿é—¨å­PLCæ•°æ®è¯»å–å·¥å…·å¯åŠ¨è„šæœ¬
:: åŠŸèƒ½ï¼šå¯åŠ¨å¤šçº¿ç¨‹PLCæ•°æ®è¯»å–ç¨‹åºï¼Œæ”¯æŒé…ç½®çº¿ç¨‹æ± å¤§å°
:: ä½œè€…ï¼šç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
:: ç‰ˆæœ¬ï¼šv1.0
:: ========================================================

REM é…ç½®å‚æ•°
set "SCRIPT_NAME=multi_thread_plc_reader.py"
set "DEFAULT_THREAD_COUNT=5"

REM æ¸…å±
cls

REM æ‰“å°ç¨‹åºä¿¡æ¯
echo ===============================================================================
echo                  å¤šçº¿ç¨‹è¥¿é—¨å­PLCæ•°æ®è¯»å–å·¥å…·
 echo                                v1.0
REM ç»˜åˆ¶ç®€å•çš„å›¾æ¡ˆ
echo  â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„  â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„  â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„  â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„
echo â–â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–Œâ–â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–Œâ–â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–Œâ–â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–Œ
echo â–â–‘â–ˆâ–€â–€â–€â–€â–€â–€â–€â–ˆâ–‘â–Œâ–â–‘â–ˆâ–€â–€â–€â–€â–€â–€â–€â–ˆâ–‘â–Œâ–â–‘â–ˆâ–€â–€â–€â–€â–€â–€â–€â–ˆâ–‘â–Œ â–€â–€â–€â–€â–ˆâ–‘â–ˆâ–€â–€â–€â–€
echo â–â–‘â–Œ       â–â–‘â–Œâ–â–‘â–Œ       â–â–‘â–Œâ–â–‘â–Œ       â–â–‘â–Œ     â–â–‘â–Œ     
echo â–â–‘â–ˆâ–„â–„â–„â–„â–„â–„â–„â–ˆâ–‘â–Œâ–â–‘â–ˆâ–„â–„â–„â–„â–„â–„â–„â–ˆâ–‘â–Œâ–â–‘â–ˆâ–„â–„â–„â–„â–„â–„â–„â–ˆâ–‘â–Œ     â–â–‘â–Œ     
echo â–â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–Œâ–â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–Œâ–â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–Œ     â–â–‘â–Œ     
echo â–â–‘â–ˆâ–€â–€â–€â–€â–€â–€â–€â–ˆâ–‘â–Œ â–€â–€â–€â–€â–€â–€â–€â–€â–€â–ˆâ–‘â–Œâ–â–‘â–ˆâ–€â–€â–€â–€â–€â–€â–€â–ˆâ–‘â–Œ     â–â–‘â–Œ     
echo â–â–‘â–Œ       â–â–‘â–Œ          â–â–‘â–Œâ–â–‘â–Œ       â–â–‘â–Œ     â–â–‘â–Œ     
echo â–â–‘â–Œ       â–â–‘â–Œ â–„â–„â–„â–„â–„â–„â–„â–„â–„â–ˆâ–‘â–Œâ–â–‘â–Œ       â–â–‘â–Œ     â–â–‘â–Œ     
echo â–â–‘â–Œ       â–â–‘â–Œâ–â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–Œâ–â–‘â–Œ       â–â–‘â–Œ     â–â–‘â–Œ     
echo  â–€         â–€  â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€  â–€         â–€       â–€      
echo ===============================================================================
echo åŠŸèƒ½è¯´æ˜Žï¼š
echo  1. æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è¯»å–å¤šä¸ªPLCçš„æ•°æ®
  echo  2. å¯é…ç½®çº¿ç¨‹æ± å¤§å°ä»¥ä¼˜åŒ–æ€§èƒ½
  echo  3. æ”¯æŒå¤šç§æ•°æ®ç±»åž‹ï¼šuint16, int16, uint32, int32, float32, float64
  echo  4. æä¾›è¯¦ç»†çš„è¯»å–ç»“æžœç»Ÿè®¡
  echo  5. è‡ªåŠ¨ç®¡ç†PLCè¿žæŽ¥å’Œæ–­å¼€
  echo  6. æ”¯æŒé…ç½®å¤šä¸ªIPåœ°å€ã€DBå—ã€åç§»é‡ç­‰å‚æ•°
  echo 
  echo æ³¨æ„ï¼šä½¿ç”¨å‰è¯·ç¡®ä¿å·²å®‰è£…snap7åº“ï¼ˆpip install python-snap7ï¼‰
echo ===============================================================================

:: è®°å½•è„šæœ¬å¼€å§‹æ‰§è¡Œæ—¶é—´
set "START_TIME=%TIME%"
echo [æ—¥å¿—] è„šæœ¬å¼€å§‹æ‰§è¡Œï¼š%DATE% %START_TIME%

:: æŸ¥æ‰¾Pythonå®‰è£…è·¯å¾„
set "PYTHON_PATH="
:: å…ˆå°è¯•ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–Python
where python >nul 2>nul
if %ERRORLEVEL% equ 0 (
    for /f "delims=" %%P in ('where python') do (
        set "PYTHON_PATH=%%P"
        goto :PythonFound
    )
)

:: å¦‚æžœçŽ¯å¢ƒå˜é‡ä¸­æ²¡æœ‰ï¼Œåˆ™æ£€æŸ¥å¸¸è§çš„Pythonå®‰è£…è·¯å¾„
echo [æ—¥å¿—] ä»ŽçŽ¯å¢ƒå˜é‡æœªæ‰¾åˆ°Pythonï¼Œå¼€å§‹æ£€æŸ¥å¸¸è§å®‰è£…è·¯å¾„...
for %%P in (
    "C:\Program Files\Python312\python.exe",
    "C:\Program Files\Python311\python.exe",
    "C:\Program Files\Python310\python.exe",
    "C:\Program Files\Python39\python.exe",
    "C:\Program Files\Python38\python.exe",
    "%LOCALAPPDATA%\Programs\Python\Python312\python.exe",
    "%LOCALAPPDATA%\Programs\Python\Python311\python.exe",
    "%LOCALAPPDATA%\Programs\Python\Python310\python.exe",
    "%LOCALAPPDATA%\Programs\Python\Python39\python.exe",
    "%LOCALAPPDATA%\Programs\Python\Python38\python.exe"
) do (
    if exist "%%~P" (
        set "PYTHON_PATH=%%~P"
        goto :PythonFound
    )
)

:PythonFound
if "%PYTHON_PATH%" == "" (
    echo ===============================================================================
    echo âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°Pythonå®‰è£…è·¯å¾„ï¼
    echo è¯·æ‰‹åŠ¨å®‰è£…Pythonï¼Œæˆ–æ£€æŸ¥Pythonæ˜¯å¦å·²æ­£ç¡®å®‰è£…ã€‚
    echo æŽ¨èå®‰è£…Python 3.8æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
    echo ===============================================================================
    pause
    exit /b 1
)

echo ===============================================================================
echo âœ… å·²æ‰¾åˆ°Pythonï¼š%PYTHON_PATH%
:: è¾“å‡ºPythonç‰ˆæœ¬ä¿¡æ¯
"%PYTHON_PATH%" --version

:: æ£€æŸ¥snap7åº“æ˜¯å¦å·²å®‰è£…
echo [æ—¥å¿—] æ£€æŸ¥snap7åº“æ˜¯å¦å·²å®‰è£…...
"%PYTHON_PATH%" -c "import snap7" >nul 2>&1
if %ERRORLEVEL% neq 0 (
    echo ===============================================================================
    echo âš ï¸  è­¦å‘Šï¼šæœªå®‰è£…snap7åº“ï¼
    echo æ­£åœ¨å°è¯•è‡ªåŠ¨å®‰è£…...
    echo ===============================================================================
    
    :: æ£€æŸ¥pipæ˜¯å¦å¯ç”¨
    "%PYTHON_PATH%" -m pip --version >nul 2>&1
    if %ERRORLEVEL% neq 0 (
        echo âŒ é”™è¯¯ï¼špipä¸å¯ç”¨ï¼è¯·ç¡®ä¿Pythonå·²æ­£ç¡®å®‰è£…å¹¶åŒ…å«pipã€‚
        pause
        exit /b 1
    )
    
    "%PYTHON_PATH%" -m pip install python-snap7
    if %ERRORLEVEL% neq 0 (
        echo ===============================================================================
        echo âŒ é”™è¯¯ï¼šsnap7åº“å®‰è£…å¤±è´¥ï¼
        echo å¯èƒ½çš„åŽŸå› ï¼š
        echo 1. ç½‘ç»œè¿žæŽ¥é—®é¢˜
        echo 2. æƒé™ä¸è¶³
        echo 3. Pythonç‰ˆæœ¬ä¸å…¼å®¹
        echo è¯·æ‰‹åŠ¨è¿è¡Œï¼špip install python-snap7
        echo ===============================================================================
        pause
        exit /b 1
    )
    echo ===============================================================================
    echo âœ… snap7åº“å®‰è£…æˆåŠŸï¼
    echo ===============================================================================
) else (
    echo âœ… snap7åº“å·²å®‰è£…ã€‚
)

:: è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦ä¿®æ”¹çº¿ç¨‹æ± å¤§å°
echo [æ—¥å¿—] é…ç½®çº¿ç¨‹æ± å¤§å°...
set /p "USER_INPUT=è¯·è¾“å…¥çº¿ç¨‹æ± å¤§å°ï¼ˆé»˜è®¤%DEFAULT_THREAD_COUNT%ï¼Œå»ºè®®1-20ï¼‰: "
if "%USER_INPUT%" == "" (
    echo [æ—¥å¿—] ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± å¤§å°ï¼š%DEFAULT_THREAD_COUNT%
    set "THREAD_COUNT=%DEFAULT_THREAD_COUNT%"
) else (
    echo [æ—¥å¿—] ç”¨æˆ·è¾“å…¥çº¿ç¨‹æ± å¤§å°ï¼š%USER_INPUT%
    set "THREAD_COUNT=%USER_INPUT%"
)

:: éªŒè¯çº¿ç¨‹æ± å¤§å°æ˜¯å¦ä¸ºæ•°å­—å¹¶åœ¨åˆç†èŒƒå›´å†…
set "VALID_INPUT=true"
for /f "delims=0123456789" %%i in ("%THREAD_COUNT%") do (
    set "VALID_INPUT=false"
)

if "%VALID_INPUT%" == "false" (
    echo ===============================================================================
    echo âŒ é”™è¯¯ï¼šè¾“å…¥çš„çº¿ç¨‹æ± å¤§å°ä¸æ˜¯æœ‰æ•ˆæ•°å­—ï¼
    echo ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± å¤§å°ï¼š%DEFAULT_THREAD_COUNT%
    set "THREAD_COUNT=%DEFAULT_THREAD_COUNT%"
    echo ===============================================================================
) else if %THREAD_COUNT% lss 1 ( 
    echo ===============================================================================
    echo âš ï¸  è­¦å‘Šï¼šçº¿ç¨‹æ± å¤§å°ä¸èƒ½å°äºŽ1ï¼
    echo ä½¿ç”¨æœ€å°çº¿ç¨‹æ± å¤§å°ï¼š1
    set "THREAD_COUNT=1"
    echo ===============================================================================
) else if %THREAD_COUNT% gtr 50 ( 
    echo ===============================================================================
    echo âš ï¸  è­¦å‘Šï¼šçº¿ç¨‹æ± å¤§å°è¿‡å¤§å¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºä¸è¶³ï¼
    echo ä½¿ç”¨æœ€å¤§çº¿ç¨‹æ± å¤§å°ï¼š50
    set "THREAD_COUNT=50"
    echo ===============================================================================
)

:: æ£€æŸ¥Pythonè„šæœ¬æ˜¯å¦å­˜åœ¨
echo [æ—¥å¿—] æ£€æŸ¥Pythonè„šæœ¬æ˜¯å¦å­˜åœ¨...
if not exist ".\%SCRIPT_NAME%" (
    echo ===============================================================================
    echo âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°Pythonè„šæœ¬ %SCRIPT_NAME%ï¼
    echo è¯·ç¡®ä¿è„šæœ¬æ–‡ä»¶å­˜åœ¨äºŽå½“å‰ç›®å½•ã€‚
    echo ===============================================================================
    pause
    exit /b 1
)

:: ä¿®æ”¹Pythonè„šæœ¬ä¸­çš„çº¿ç¨‹æ± å¤§å°
echo [æ—¥å¿—] æ›´æ–°Pythonè„šæœ¬ä¸­çš„çº¿ç¨‹æ± é…ç½®...
set "TEMP_SCRIPT=%TEMP%\%SCRIPT_NAME%.tmp"
if exist "%TEMP_SCRIPT%" del "%TEMP_SCRIPT%"

:: ä½¿ç”¨PowerShellæ›¿æ¢çº¿ç¨‹æ± å¤§å°ï¼ˆé¿å…æ‰¹å¤„ç†ä¸­çš„å¤æ‚æ–‡æœ¬å¤„ç†ï¼‰
powershell -Command "
    $content = Get-Content -Path '.\%SCRIPT_NAME%' -Raw
    $pattern = 'plc_manager = PLCManager\(max_workers=\d+\)'
    $replacement = 'plc_manager = PLCManager\(max_workers=%THREAD_COUNT%\)'
    $content -replace $pattern, $replacement | Set-Content -Path '%TEMP_SCRIPT%' -Encoding UTF8
"

:: æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
if not exist "%TEMP_SCRIPT%" (
    echo ===============================================================================
    echo âš ï¸  è­¦å‘Šï¼šæ— æ³•ä¿®æ”¹Pythonè„šæœ¬é…ç½®ï¼
    echo å¯èƒ½çš„åŽŸå› ï¼š
    echo 1. è„šæœ¬æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ
    echo 2. æƒé™ä¸è¶³
    echo ä½¿ç”¨è„šæœ¬é»˜è®¤é…ç½®è¿è¡Œ...
    echo ===============================================================================
    goto :RunScript
)

:: æ›¿æ¢åŽŸè„šæœ¬
copy /y "%TEMP_SCRIPT%" ".\%SCRIPT_NAME%" >nul
if %ERRORLEVEL% neq 0 (
    echo ===============================================================================
    echo âš ï¸  è­¦å‘Šï¼šæ— æ³•ä¿å­˜ä¿®æ”¹åŽçš„è„šæœ¬ï¼
    echo ä½¿ç”¨è„šæœ¬é»˜è®¤é…ç½®è¿è¡Œ...
    echo ===============================================================================
    goto :RunScript
)

if exist "%TEMP_SCRIPT%" del "%TEMP_SCRIPT%"

echo ===============================================================================
echo âœ… çº¿ç¨‹æ± å¤§å°å·²è®¾ç½®ä¸ºï¼š%THREAD_COUNT%
echo ===============================================================================

:RunScript
:: è¿è¡ŒPythonè„šæœ¬
echo ===============================================================================
echo ðŸš€ æ­£åœ¨å¯åŠ¨å¤šçº¿ç¨‹PLCæ•°æ®è¯»å–ç¨‹åº...
echo ï¼ˆæŒ‰Ctrl+Cå¯ä»¥éšæ—¶ç»ˆæ­¢ç¨‹åºï¼‰
echo ===============================================================================

:: å°è¯•è¿è¡Œè„šæœ¬å¹¶æ•èŽ·é”™è¯¯
set "SCRIPT_ERROR=0"
"%PYTHON_PATH%" %SCRIPT_NAME%
set "SCRIPT_ERROR=%ERRORLEVEL%"

:: è®°å½•è„šæœ¬ç»“æŸæ‰§è¡Œæ—¶é—´
set "END_TIME=%TIME%"
echo [æ—¥å¿—] è„šæœ¬æ‰§è¡Œç»“æŸï¼š%DATE% %END_TIME%

:: æ£€æŸ¥è¿è¡Œç»“æžœ
if %SCRIPT_ERROR% neq 0 (
    echo ===============================================================================
    echo âŒ ç¨‹åºæ‰§è¡Œå‡ºé”™ï¼é”™è¯¯ä»£ç ï¼š%SCRIPT_ERROR%
    echo å¯èƒ½çš„åŽŸå› ï¼š
    echo 1. PLCè¿žæŽ¥å¤±è´¥
    echo 2. é…ç½®æ–‡ä»¶é”™è¯¯
    echo 3. Pythonè„šæœ¬å†…éƒ¨é”™è¯¯
    echo è¯·æŸ¥çœ‹ç¨‹åºè¾“å‡ºçš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
    echo ===============================================================================
) else (
    echo ===============================================================================
    echo âœ… ç¨‹åºæ‰§è¡Œå®Œæˆï¼
    echo æ•°æ®è¯»å–ä»»åŠ¡å·²å®Œæˆã€‚
    echo ===============================================================================
)

:: ç­‰å¾…ç”¨æˆ·æŒ‰é”®é€€å‡º
echo æŒ‰ä»»æ„é”®é€€å‡º...
pause >nul

endlocal