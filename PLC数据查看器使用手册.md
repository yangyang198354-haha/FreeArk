# PLC数据查看器使用手册

## 1. 工具简介

PLC数据查看器是一个用于朗诗乐府自由方舟项目的实用工具，主要用于实时查询和显示PLC设备的累计用量数据，并支持运行模式的下发操作。该工具提供了直观的图形界面，方便用户快速获取和管理PLC数据。

## 2. 系统要求

- 操作系统：Windows系统
- Python环境：Python 3.8或更高版本
- 依赖库：pandas, tkinter等

## 3. 启动方式

### 3.1 直接运行批处理文件

1. 在项目根目录下找到 `run_plc_data_viewer_gui.bat` 文件
2. 双击该文件即可启动程序
3. 程序会自动检查Python环境和依赖项

### 3.2 启动时的环境检查

- 程序会自动检查是否安装了Python环境
- 如未安装Python，会提示用户安装Python 3.8或更高版本
- 程序会检查必要的依赖项（如pandas），如缺少会提示运行 `install_and_use.bat` 安装依赖

## 4. 界面介绍

PLC数据查看器主界面采用标签页式设计，包含两个主要标签页：

### 4.1 累计用量查询标签页

- **操作区**：包含三个主要按钮和文件选择显示
  - 选择JSON配置文件：用于选择包含PLC配置信息的JSON文件
  - 开始读取PLC数据：开始从选定的PLC设备读取数据
  - 导出数据：将查询到的数据导出为JSON或Excel格式
  - 已选择文件显示：显示当前已选择的配置文件

- **数据展示区**：以表格形式显示从PLC读取的数据
  - 楼栋：显示设备所属的楼栋信息
  - 房间号：显示设备所属的房间号
  - 专有部分坐落：显示设备的具体位置信息
  - 累计制热量：显示设备的累计制热量数据
  - 累计制冷量：显示设备的累计制冷量数据
  - 状态：显示数据采集的状态
  - 采集时间：显示数据采集的时间戳

- **状态条**：显示程序的当前状态和操作反馈

### 4.2 模式下发标签页

- **模式下发控制区**：用于配置和下发设备运行模式
  - 配置文件：显示已选择的模式下发配置文件
  - 选择JSON配置文件：选择包含设备信息的配置文件
  - 运行模式：下拉选择要下发的运行模式（制冷、制热、通风、除湿）
  - 确认下发：将选定的模式下发到设备

- **下发结果区**：以表格形式显示模式下发的结果
  - 楼栋：显示设备所属的楼栋
  - 房间号：显示设备所属的房间号
  - PLC IP：显示设备的IP地址
  - 参数名称：显示下发的参数名称
  - 下发值：显示下发的具体数值
  - 下发模式：显示下发的模式名称
  - 状态：显示下发操作的状态（成功/失败）
  - 消息：显示操作的详细消息

## 5. 功能使用指南

### 5.1 累计用量查询功能

#### 5.1.1 读取PLC数据

1. 点击「选择JSON配置文件」按钮
2. 在弹出的文件选择对话框中，导航到项目的`resource`目录
3. 选择一个或多个JSON配置文件（支持多选）
4. 点击「开始读取PLC数据」按钮
5. 程序将开始从PLC设备读取数据，并在表格中显示
6. 状态栏会显示当前处理进度

#### 5.1.2 导出数据

1. 确保表格中已显示数据
2. 点击「导出数据」按钮
3. 在弹出的导出格式选择对话框中，选择「JSON格式」或「Excel格式」
4. 点击「确认」按钮
5. 在文件保存对话框中，选择保存路径并设置文件名
6. 点击「保存」按钮完成导出
7. 导出成功后会显示确认消息

### 5.2 模式下发功能

#### 5.2.1 下发设备运行模式

1. 切换到「模式下发」标签页
2. 点击「选择JSON配置文件」按钮
3. 在弹出的文件选择对话框中，选择包含设备信息的JSON配置文件
4. 从「运行模式」下拉菜单中选择要下发的模式（制冷、制热、通风或除湿）
   - 注意：除湿模式在当前版本中未完全实现，系统会使用制冷模式替代
5. 点击「确认下发」按钮
6. 程序将开始向设备下发模式配置
7. 下发结果会实时显示在表格中
8. 状态栏会显示下发完成的统计信息（成功/总数）

## 6. 表格操作功能

### 6.1 数据排序

在「累计用量查询」标签页中，点击表格列标题可以对该列数据进行排序。再次点击可以切换排序方向（升序/降序）。

### 6.2 数据滚动

表格提供了水平和垂直滚动条，可以方便地查看大量数据。

## 7. 注意事项

1. **配置文件格式**：确保选择的JSON配置文件格式正确，符合系统要求
2. **网络连接**：确保与PLC设备的网络连接正常
3. **权限问题**：运行程序时可能需要管理员权限以确保正常访问PLC设备
4. **模式下发限制**：除湿模式目前会使用制冷模式替代，这是已知的功能限制
5. **Excel导出**：导出Excel文件时，如果系统缺少xlsxwriter库，程序会使用默认引擎导出

## 8. 常见问题与解决方案

1. **问题**：程序启动时报「未找到Python」错误
   **解决方案**：请安装Python 3.8或更高版本，并确保Python已添加到系统环境变量中

2. **问题**：提示缺少依赖项
   **解决方案**：运行项目根目录下的`install_and_use.bat`文件安装所需依赖

3. **问题**：无法连接到PLC设备
   **解决方案**：检查网络连接和PLC设备状态，确保IP地址配置正确

4. **问题**：导出Excel文件失败
   **解决方案**：尝试选择JSON格式导出，或安装xlsxwriter库

5. **问题**：除湿模式下发无效
   **解决方案**：这是已知限制，系统会自动使用制冷模式替代

## 9. 配置文件详解

PLC数据查看器使用多个配置文件来定义PLC连接参数、数据采集和输出设置。以下是对三个主要配置文件的详细介绍和配置方法。

### 9.1 plc_config.json - PLC数据读取配置文件

该文件定义了从PLC设备读取数据时需要的参数配置，主要用于累计用量查询功能。

#### 9.1.1 文件结构

```json
{
  "parameters": {
    "参数名称": {
      "name": "参数名称",
      "description": "参数描述",
      "db_num": 数据库编号,
      "offset": 偏移量,
      "length": 数据长度,
      "data_type": "数据类型"
    }
  },
  "config_info": {
    "version": "版本号",
    "create_time": "创建时间",
    "description": "配置文件描述"
  }
}
```

#### 9.1.2 配置说明

- **parameters**: 定义需要从PLC读取的参数列表
  - **参数名称**: 每个参数的唯一标识符
    - **name**: 参数的内部名称
    - **description**: 参数的中文描述
    - **db_num**: PLC数据库编号
    - **offset**: 参数在数据库中的偏移量
    - **length**: 参数的数据长度
    - **data_type**: 参数的数据类型（如int32）
- **config_info**: 配置文件的元信息

#### 9.1.3 默认配置示例

```json
{
  "parameters": {
    "total_hot_quantity": {
      "name": "total_hot_quantity",
      "description": "累计制热量",
      "db_num": 14,
      "offset": 442,
      "length": 4,
      "data_type": "int32"
    },
    "total_cold_quantity": {
      "name": "total_cold_quantity",
      "description": "累计制冷量",
      "db_num": 14,
      "offset": 448,
      "length": 4,
      "data_type": "int32"
    }
  },
  "config_info": {
    "version": "1.0",
    "create_time": "2024-07-11",
    "description": "PLC数据读取配置文件"
  }
}
```

### 9.2 plc_mode_update_config.json - PLC运行模式配置文件

该文件定义了向PLC设备写入运行模式时需要的参数配置，主要用于模式下发功能。

#### 9.2.1 文件结构

```json
{
  "parameters": {
    "参数名称": {
      "name": "参数名称",
      "description": "参数描述",
      "db_num": 数据库编号,
      "offset": 偏移量,
      "length": 数据长度,
      "data_type": "数据类型"
    }
  },
  "config_info": {
    "version": "版本号",
    "create_time": "创建时间",
    "description": "配置文件描述"
  }
}
```

#### 9.2.2 配置说明

- **parameters**: 定义需要写入到PLC的参数列表
  - **参数名称**: 每个参数的唯一标识符
    - **name**: 参数的内部名称
    - **description**: 参数的中文描述
    - **db_num**: PLC数据库编号
    - **offset**: 参数在数据库中的偏移量
    - **length**: 参数的数据长度
    - **data_type**: 参数的数据类型（如int8）
- **config_info**: 配置文件的元信息

#### 9.2.3 默认配置示例

```json
{
  "parameters": {
    "mode": {
      "name": "mode",
      "description": "运行模式",
      "db_num": 14,
      "offset": 89,
      "length": 8,
      "data_type": "int8"
    },
    "central energy supply": {
      "name": "central energy supply",
      "description": "集中能源供应",
      "db_num": 14,
      "offset": 103,
      "length": 8,
      "data_type": "int8"
    }
  },
  "config_info": {
    "version": "1.0",
    "create_time": "2024-10-21",
    "description": "PLC运行模式配置文件"
  }
}
```

### 9.3 output_config.json - 数据输出配置文件

该文件控制数据收集结果的保存格式，支持JSON、Excel和MQTT输出方式。

#### 9.3.1 文件结构

```json
{
  "output": {
    "type": "输出类型",
    "excel": {
      "enabled": true/false,
      "file_name": "文件名",
      "directory": "输出目录",
      "include_all_params": true/false
    },
    "json": {
      "enabled": true/false
    },
    "mqtt": {
      "enabled": true/false,
      "server": {
        "host": "MQTT服务器地址",
        "port": 端口号,
        "username": "用户名",
        "password": "密码",
        "tls_enabled": true/false,
        "pool_size": 连接池大小
      },
      "topic": {
        "prefix": "主题前缀"
      },
      "qos": QoS级别,
      "retain": true/false
    }
  },
  "config_info": {
    "version": "版本号",
    "create_time": "创建时间",
    "description": "配置文件描述"
  }
}
```

#### 9.3.2 配置说明

- **output**: 输出相关配置
  - **type**: 指定主要输出类型（如"Excel"）
  - **excel**: Excel输出配置
    - **enabled**: 是否启用Excel输出
    - **file_name**: Excel文件名
    - **directory**: 输出目录
    - **include_all_params**: 是否包含所有参数
  - **json**: JSON输出配置
    - **enabled**: 是否启用JSON输出
  - **mqtt**: MQTT发布配置
    - **enabled**: 是否启用MQTT发布
    - **server**: MQTT服务器配置
    - **topic**: MQTT主题配置
    - **qos**: MQTT服务质量级别
    - **retain**: 是否设置保留消息
- **config_info**: 配置文件的元信息

#### 9.3.3 默认配置示例

```json
{
  "output": {
    "type": "Excel",
    "excel": {
      "enabled": false,
      "file_name": "累计用量",
      "directory": "./output/",
      "include_all_params": false
    },
    "json": {
      "enabled": false
    },
    "mqtt": {
      "enabled": true,
      "server": {
        "host": "192.168.31.97",
        "port": 32795,
        "username": "",
        "password": "",
        "tls_enabled": false,
        "pool_size": 5
      },
      "topic": {
        "prefix": "/datacollection/plc/to/collector/"
      },
      "qos": 1,
      "retain": false
    }
  },
  "config_info": {
    "version": "1.1",
    "create_time": "2025-10-13",
    "description": "数据输出配置文件，控制数据收集结果的保存格式，支持JSON、Excel和MQTT输出"
  }
}
```

### 9.4 配置文件修改方法

1. 使用任何文本编辑器（如记事本、VS Code等）打开配置文件
2. 根据实际需求修改相应的配置项
3. 保存修改后的文件
4. 确保文件编码为UTF-8格式
5. 重启PLC数据查看器使配置生效

### 9.5 注意事项

- 修改配置文件时请仔细检查JSON格式的正确性
- 数据库编号(db_num)、偏移量(offset)等参数需要与实际PLC设备匹配
- MQTT配置需要确保服务器地址、端口等信息准确无误
- 建议在修改前备份原始配置文件

## 10. 联系与支持

如有其他问题或需要进一步的技术支持，请联系系统管理员或开发团队。

## 11. 网络配置指南

为了能够完整读取 `resource` 目录中1~10个楼栋专有部分的数据，需要为运行程序的计算机网络适配器配置10个不同的IP地址，分别是192.168.1.253、192.168.2.253一直到192.168.10.253，子网掩码均为255.255.255.0。以下是在Windows 11系统下的具体配置方法：

### 11.1 打开网络连接管理窗口

1. 按 `Windows + R` 键打开「运行」对话框
2. 输入 `ncpa.cpl` 命令，然后按回车键
3. 系统将打开「网络连接」窗口，显示所有可用的网络适配器

### 11.2 配置TCP/IPv4属性

1. 在「网络连接」窗口中，找到并右键单击需要配置的网络适配器（通常是「以太网」或「WLAN」）
2. 从右键菜单中选择「属性」选项
3. 在属性窗口中，找到并双击「Internet协议版本4（TCP/IPv4）」

### 11.3 设置第一个IP地址（主IP）

1. 在TCP/IPv4属性窗口中，选择「使用下面的IP地址」选项
2. 输入第一个IP地址，例如 `192.168.1.253`
3. 子网掩码设置为 `255.255.255.0`
4. 网关设置可以根据实际网络环境配置，或者留空
5. DNS服务器地址可以使用默认的自动获取，或根据实际情况设置

### 11.4 添加其他IP地址（192.168.2.253到192.168.10.253）

1. 在TCP/IPv4属性窗口中，点击「高级」按钮
2. 在「高级TCP/IP设置」窗口中，在「IP地址」区域点击「添加」按钮
3. 在弹出的对话框中，输入第二个IP地址 `192.168.2.253` 和子网掩码 `255.255.255.0`，然后点击「添加」
4. 重复步骤3，依次添加剩余的IP地址：`192.168.3.253`、`192.168.4.253`、……一直到 `192.168.10.253`，所有IP地址的子网掩码均为 `255.255.255.0`
5. 添加完成后，点击「确定」按钮关闭「高级TCP/IP设置」窗口
6. 再次点击「确定」按钮关闭TCP/IPv4属性窗口
7. 最后点击「关闭」按钮关闭网络适配器属性窗口

### 11.5 验证IP地址配置

1. 按 `Windows + R` 键打开「运行」对话框
2. 输入 `cmd` 命令，然后按回车键打开命令提示符
3. 在命令提示符中输入 `ipconfig /all` 命令并按回车
4. 检查输出结果中，确认所有10个IP地址都已成功配置到相应的网络适配器上

### 11.6 注意事项

- 配置多个IP地址时，请确保不要与网络中的其他设备IP地址冲突
- 如果网络环境中有DHCP服务器，建议关闭该网络适配器的DHCP功能，完全使用静态IP配置
- 配置完成后，建议重启网络适配器或计算机，以确保配置生效
- 如果遇到连接问题，可以尝试禁用并重新启用网络适配器，或检查防火墙设置

---

*本手册适用于朗诗乐府自由方舟累计用量采集程序*
*最后更新时间：2025年*