<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自由方舟能耗采集平台 - 主页</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f5f7fa;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      
      .header {
        background-color: #409eff;
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
      }
      
      .header h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      
      /* 用户下拉菜单样式 */
      .user-dropdown {
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        padding: 0.5rem;
        border-radius: 4px;
        transition: background-color 0.3s;
      }
      
      .user-dropdown:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
      
      .user-dropdown::after {
        content: '▼';
        font-size: 0.5em;
        transition: transform 0.3s;
      }
      
      .user-dropdown.open::after {
        transform: rotate(180deg);
      }
      
      .user-dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background-color: white;
        color: #333;
        border-radius: 4px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        min-width: 150px;
        z-index: 1000;
        display: none;
      }
      
      .user-dropdown-menu.show {
        display: block;
      }
      
      .user-dropdown-menu ul {
        list-style: none;
        padding: 0.5rem 0;
        margin: 0;
      }
      
      .user-dropdown-menu li {
        padding: 0;
      }
      
      .user-dropdown-menu a {
        display: block;
        padding: 0.75rem 1rem;
        color: #333;
        text-decoration: none;
        transition: background-color 0.3s;
      }
      
      .user-dropdown-menu a:hover {
        background-color: #f5f7fa;
      }
      
      .main-container {
        display: flex;
        flex: 1;
        margin-top: 5rem;
        min-height: calc(100vh - 5rem);
      }
      
      /* 左侧导航栏 */
      .sidebar {
        width: 200px;
        background-color: #304156;
        color: #fff;
        position: fixed;
        left: 0;
        top: 5rem;
        bottom: 0;
        overflow-y: auto;
      }
      
      .nav-menu {
        list-style: none;
        padding: 1rem 0;
      }
      
      .nav-item {
        padding: 0 1rem;
      }
      
      .nav-link {
        display: block;
        padding: 0.875rem 1rem;
        color: #c0c4cc;
        text-decoration: none;
        border-radius: 4px;
        transition: all 0.3s;
        margin-bottom: 0.25rem;
      }
      
      .nav-link:hover {
        color: #fff;
        background-color: #409eff;
      }
      
      .nav-link.active {
        color: #fff;
        background-color: #409eff;
      }
      
      /* 下拉菜单样式 */
      .dropdown {
        position: relative;
      }
      
      .dropdown-menu {
        display: block;
        position: static; /* 改为静态定位，使其在导航栏内展开 */
        background-color: #304156; /* 与导航栏背景颜色一致 */
        border: none;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
        width: 100%;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.6s ease-in-out; /* 添加更慢的展开/折叠动画 */
      }
      
      .dropdown-menu.show {
        max-height: 500px; /* 设置一个足够大的值以容纳所有菜单项 */
      }
      
      /* 为下拉按钮添加展开/折叠图标 */
      .dropdown-toggle::after {
        content: ' ▼';
        font-size: 0.5em;
        margin-left: 0.5em;
        transition: transform 0.5s;
      }
      
      .dropdown-toggle.collapsed::after {
        transform: rotate(-90deg);
      }
      
      .dropdown-item {
        display: block;
        width: 100%;
        padding: 0.75rem 1.5rem 0.75rem 2.5rem; /* 增加左侧padding以创建缩进效果 */
        clear: both;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.8); /* 与导航栏文字颜色一致 */
        text-align: left;
        white-space: nowrap;
        background-color: transparent;
        border: 0;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .dropdown-item:hover, .dropdown-item:focus {
        color: #fff;
        text-decoration: none;
        background-color: rgba(255, 255, 255, 0.1); /* 半透明背景 */
        padding-left: 2.75rem; /* 悬停时轻微左移 */
      }
      
      .dropdown-item.active {
        color: #fff;
        text-decoration: none;
        background-color: #007bff;
        padding-left: 2.75rem;
      }
      
      /* 确保下拉菜单正确显示在导航栏内 */
      .sidebar .nav-menu {
        width: 100%;
      }
      
      .nav-item.dropdown {
        width: 100%;
      }
      
      .nav-item.dropdown > .nav-link {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      /* 右侧内容区 */
      .content {
        flex: 1;
        margin-left: 200px;
        padding: 2rem;
      }
      
      .page-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        min-height: calc(100vh - 10rem);
        padding: 2rem;
      }
      
      .page-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #ebeef5;
      }
      
      .page-header h2 {
        color: #303133;
        font-size: 1.5rem;
        font-weight: 600;
      }
      
      .empty-page {
        text-align: center;
        padding: 4rem 2rem;
        color: #909399;
      }
      
      .empty-page h3 {
        color: #606266;
        margin-bottom: 1rem;
      }
      
      .no-access {
        text-align: center;
        padding: 4rem 2rem;
        color: #909399;
        margin-left: 200px;
        margin-top: 5rem;
      }
      
      .no-access h2 {
        margin-bottom: 1rem;
        color: #606266;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>自由方舟能耗采集平台</h1>
      <div class="user-info">
        <div id="userName" class="user-dropdown">
          用户
        </div>
        <div id="userDropdownMenu" class="user-dropdown-menu">
          <ul>
            <li><a href="#" onclick="editProfile()">编辑个人资料</a></li>
            <li><a href="#" onclick="changePassword()">修改登录密码</a></li>
            <li><a href="#" onclick="logout()">退出登录</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    <div id="noAccess" class="no-access" style="display: none;">
      <h2>未授权访问</h2>
      <p>您尚未登录或登录已过期，请重新登录</p>
      <button onclick="window.location.href='index.html'" class="logout-button" style="margin-top: 1rem;">前往登录</button>
    </div>
    
    <div id="dashboardContent" class="main-container" style="display: none;">
      <!-- 左侧导航栏 -->
      <aside class="sidebar">
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="#dashboard" class="nav-link active" onclick="switchPage('dashboard')">系统看板</a>
          </li>
          <li class="nav-item">
            <a href="#usage" class="nav-link" onclick="switchPage('usage')">用量查询</a>
          </li>
          <li class="nav-item">
            <a href="#services" class="nav-link" onclick="switchPage('services')">服务管理</a>
          </li>
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle collapsed" id="userManagementDropdown">用户管理</a>
            <div class="dropdown-menu">
              <a href="#createUser" class="dropdown-item" onclick="switchPage('createUser')">创建用户</a>
              <a href="#userList" class="dropdown-item" onclick="switchPage('userList')">用户列表</a>
            </div>
          </li>
        </ul>
      </aside>
      
      <!-- 右侧内容区 -->
      <main class="content">
        <!-- 系统看板页面 -->
        <div id="dashboardPage" class="page-container">
          <div class="page-header">
            <h2>系统看板</h2>
          </div>
          <!-- 空白内容区域 -->
        </div>
        
        <!-- 用量查询页面 -->
        <div id="usagePage" class="page-container" style="display: none;">
          <div class="page-header">
            <h2>用量查询</h2>
          </div>
          <!-- 空白内容区域 -->
        </div>
        
        <!-- 服务管理页面 -->
        <div id="servicesPage" class="page-container" style="display: none;">
          <div class="page-header">
            <h2>服务管理</h2>
          </div>
          <!-- 空白内容区域 -->
        </div>
        
        <!-- 创建用户页面 -->
        <div id="createUserPage" class="page-container" style="display: none;">
          <div class="page-header">
            <h2>创建用户</h2>
          </div>
          
          <!-- 用户创建表单 -->
          <div class="card">
            <div class="card-body">
              <form id="createUserForm" onsubmit="return false;">
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="username">用户名 *</label>
                    <input type="text" class="form-control" id="username" required>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="email">电子邮箱 *</label>
                    <input type="email" class="form-control" id="email" required>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="firstName">名字 *</label>
                    <input type="text" class="form-control" id="firstName" required>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="lastName">姓氏 *</label>
                    <input type="text" class="form-control" id="lastName" required>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="password">密码 *</label>
                    <input type="password" class="form-control" id="password" required>
                    <small class="form-text text-muted">密码必须至少8位，包含字母、数字和特殊字符</small>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="confirmPassword">确认密码 *</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="role">角色</label>
                    <select class="form-control" id="role">
                      <option value="user">普通用户</option>
                      <option value="admin">管理员</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="department">部门</label>
                    <input type="text" class="form-control" id="department">
                  </div>
                  <div class="form-group col-md-6">
                    <label for="position">职位</label>
                    <input type="text" class="form-control" id="position">
                  </div>
                </div>
                <button type="submit" class="btn btn-primary" id="createUserBtn">创建用户</button>
                <div id="createUserMessage" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>
        
        <!-- 用户列表页面 -->
        <div id="userListPage" class="page-container" style="display: none;">
          <div class="page-header">
            <h2>用户列表</h2>
          </div>
          
          <!-- 用户列表 -->
          <div class="card">
            <div class="card-body">
              <div id="userListMessage" class="mb-3"></div>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>用户名</th>
                      <th>电子邮箱</th>
                      <th>姓名</th>
                      <th>角色</th>
                      <th>部门</th>
                      <th>职位</th>
                      <th>创建时间</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="userListBody">
                    <!-- 用户数据将通过JavaScript动态添加 -->
                  </tbody>
                </table>
              </div>
              <div id="userListMessage" class="mt-3"></div>
            </div>
          </div>
        </div>
        
        <!-- 编辑用户页面 -->
        <div id="editUserPage" class="page-container" style="display: none;">
          <div class="page-header">
            <h2 id="editUserPageTitle">编辑用户</h2>
            <button type="button" class="btn btn-secondary" onclick="switchPage('userList')">返回用户列表</button>
          </div>
          
          <div class="card">
            <div class="card-body">
              <form id="editUserForm" onsubmit="return false;">
                <input type="hidden" id="editUserId">
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="editUsername">用户名 *</label>
                    <input type="text" class="form-control" id="editUsername" readonly>
                    <small class="form-text text-muted">用户名不可修改</small>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="editEmail">电子邮箱 *</label>
                    <input type="email" class="form-control" id="editEmail">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="editFirstName">名字</label>
                    <input type="text" class="form-control" id="editFirstName">
                  </div>
                  <div class="form-group col-md-6">
                    <label for="editLastName">姓氏</label>
                    <input type="text" class="form-control" id="editLastName">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="editPassword">密码 (留空表示不修改)</label>
                    <input type="password" class="form-control" id="editPassword" placeholder="留空表示不修改密码">
                  </div>
                  <div class="form-group col-md-6">
                    <label for="editRole">角色</label>
                    <select class="form-control" id="editRole" disabled>
                      <option value="user">普通用户</option>
                      <option value="admin">管理员</option>
                    </select>
                    <small class="form-text text-muted">角色不可修改</small>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="editDepartment">部门</label>
                    <input type="text" class="form-control" id="editDepartment">
                  </div>
                  <div class="form-group col-md-6">
                    <label for="editPosition">职位</label>
                    <input type="text" class="form-control" id="editPosition">
                  </div>
                </div>
                <div class="form-group">
                  <button type="button" class="btn btn-secondary mr-2" onclick="switchPage('userList')">取消</button>
                  <button type="button" class="btn btn-primary" id="saveUserBtn">保存更改</button>
                </div>
                <div id="editUserMessage" class="mt-3"></div>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>
    
    <script>
      // 检查用户是否已登录
      function checkAuthentication() {
        const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
        const userToken = localStorage.getItem('userToken');
        
        if (isAuthenticated && userToken) {
          // 显示仪表板内容
          document.getElementById('dashboardContent').style.display = 'block';
          document.getElementById('noAccess').style.display = 'none';
          loadUserInfo();
        } else {
          // 显示未授权访问
          document.getElementById('dashboardContent').style.display = 'none';
          document.getElementById('noAccess').style.display = 'block';
        }
      }
      
      // 加载用户信息
      function loadUserInfo() {
        const userInfoStr = localStorage.getItem('userInfo');
        if (userInfoStr) {
          try {
            const userInfo = JSON.parse(userInfoStr);
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
              // 显示姓名而不是用户名，使用formatFullName函数进行格式化
              const fullName = formatFullName(userInfo.first_name || '', userInfo.last_name || '');
              userNameElement.textContent = fullName || userInfo.username || '用户';
            }
            
            // 根据用户角色显示或隐藏用户管理导航项
            const userManagementDropdown = document.querySelector('.nav-item.dropdown');
            if (userManagementDropdown) {
              if (userInfo && userInfo.role === 'admin') {
                userManagementDropdown.style.display = 'block';
              } else {
                userManagementDropdown.style.display = 'none';
              }
            }
          } catch (e) {
            console.error('解析用户信息失败:', e);
          }
        }
      }
      
      // 切换用户下拉菜单显示状态
      function toggleUserDropdown() {
        const userDropdown = document.getElementById('userName');
        const dropdownMenu = document.getElementById('userDropdownMenu');
        
        userDropdown.classList.toggle('open');
        dropdownMenu.classList.toggle('show');
      }
      
      // 关闭用户下拉菜单
      function closeUserDropdown() {
        const userDropdown = document.getElementById('userName');
        const dropdownMenu = document.getElementById('userDropdownMenu');
        
        userDropdown.classList.remove('open');
        dropdownMenu.classList.remove('show');
      }
      
      // 编辑个人资料
      function editProfile() {
        const userInfoStr = localStorage.getItem('userInfo');
        if (userInfoStr) {
          try {
            const userInfo = JSON.parse(userInfoStr);
            // 为所有用户（包括普通用户）设置编辑自己的ID
            localStorage.setItem('editingUserId', userInfo.id);
            switchPage('editUser');
          } catch (e) {
            console.error('解析用户信息失败:', e);
          }
        }
        closeUserDropdown();
      }
      
      // 修改登录密码
      function changePassword() {
        // 这里暂时使用alert提示功能开发中
        alert('密码修改功能开发中');
        closeUserDropdown();
      }
      
      // 退出登录
      function logout() {
        // 清除localStorage中的登录信息
        localStorage.removeItem('userToken');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('isAuthenticated');
        
        // 跳转到登录页面
        window.location.href = 'index.html';
      }
      
      // 页面切换函数
      function switchPage(pageId) {
        // 检查用户是否尝试访问用户管理相关页面
        if (pageId === 'createUser' || pageId === 'userList') {
          const userInfo = JSON.parse(localStorage.getItem('userInfo'));
          if (!userInfo || userInfo.role !== 'admin') {
            // 普通用户尝试访问用户管理，重定向到系统看板
            pageId = 'dashboard';
            alert('您没有权限访问用户管理页面');
          }
        }
        // editUser页面允许普通用户访问，但只能编辑自己的资料
        else if (pageId === 'editUser') {
          const userInfo = JSON.parse(localStorage.getItem('userInfo'));
          const editingUserId = localStorage.getItem('editingUserId');
          
          // 普通用户只能编辑自己的资料
          if (userInfo && userInfo.role !== 'admin' && editingUserId !== userInfo.id.toString()) {
            localStorage.setItem('editingUserId', userInfo.id.toString());
          }
        }
        
        // 隐藏所有页面
        const pages = ['dashboardPage', 'usagePage', 'servicesPage', 'createUserPage', 'userListPage', 'editUserPage'];
        pages.forEach(id => {
          document.getElementById(id).style.display = 'none';
        });
        
        // 显示选中的页面
        document.getElementById(`${pageId}Page`).style.display = 'block';
        
        // 更新导航项的活动状态
        const navLinks = document.querySelectorAll('.nav-link, .dropdown-item');
        navLinks.forEach(link => {
          link.classList.remove('active');
        });
        
        // 为普通导航项添加活动状态
        const navLink = document.querySelector(`.nav-link[onclick="switchPage('${pageId}')"]`);
        if (navLink) {
          navLink.classList.add('active');
        }
        // 为下拉菜单项添加活动状态
        const dropdownItem = document.querySelector(`.dropdown-item[onclick="switchPage('${pageId}')"]`);
        if (dropdownItem) {
          dropdownItem.classList.add('active');
          // 同时将下拉按钮也设为活动状态
          dropdownItem.closest('.dropdown').querySelector('.nav-link').classList.add('active');
        }
        
        // 加载用户列表（如果切换到用户列表页面）
        if (pageId === 'userList' && localStorage.getItem('isAuthenticated') === 'true') {
          const userInfo = JSON.parse(localStorage.getItem('userInfo'));
          if (userInfo && userInfo.role === 'admin') {
            loadUserList();
          }
        }
        
        // 加载用户详情（如果切换到编辑用户页面且有userId参数）
        if (pageId === 'editUser' && localStorage.getItem('isAuthenticated') === 'true') {
          const userId = localStorage.getItem('editingUserId');
          if (userId) {
            loadUserForEdit(userId);
          }
        }
      }
      
      // 验证密码规则
      function validatePassword(password) {
        console.log('验证密码:', password);
        // 至少8位，包含字母、数字和特殊字符
        // 进一步扩大特殊字符范围，允许几乎所有常见特殊字符
        // 使用更宽松的规则：至少8位，必须包含字母和数字，可选包含特殊字符
        const hasLetter = /[A-Za-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const isValidLength = password.length >= 8;
        
        console.log('密码验证结果:', {hasLetter, hasNumber, isValidLength});
        
        // 暂时放宽要求，只检查长度、字母和数字
        return isValidLength && hasLetter && hasNumber;
      }
      
      // 创建用户
      function createUser() {
        // 验证用户权限
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        const userToken = localStorage.getItem('userToken');
        console.log('用户信息:', userInfo);
        console.log('用户令牌存在:', !!userToken);
        if (!userInfo || userInfo.role !== 'admin') {
          alert('您没有权限执行此操作');
          return;
        }
        
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const role = document.getElementById('role').value;
        const department = document.getElementById('department').value;
        const position = document.getElementById('position').value;
        
        const messageElement = document.getElementById('createUserMessage');
        
        // 验证必填字段
        if (!username || !email || !firstName || !lastName || !password || !confirmPassword) {
          messageElement.innerHTML = '<div class="alert alert-danger">请填写所有必填字段</div>';
          return;
        }
        
        // 验证密码规则
        if (!validatePassword(password)) {
          messageElement.innerHTML = '<div class="alert alert-danger">密码必须至少8位，包含字母和数字</div>';
          return;
        }
        
        // 验证两次密码是否一致
        if (password !== confirmPassword) {
          messageElement.innerHTML = '<div class="alert alert-danger">两次输入的密码不一致</div>';
          return;
        }
        
        const userData = {
          username,
          email,
          first_name: firstName,
          last_name: lastName,
          password,
          role,
          department,
          position
        };
        
        fetch('http://localhost:8000/api/users/create/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Token ${localStorage.getItem('userToken')}`
          },
          body: JSON.stringify(userData)
        })
        .then(response => {
          // 记录响应状态码，帮助调试
          console.log('响应状态码:', response.status);
          
          // 尝试解析JSON响应
          return response.json().then(data => {
            // 即使状态码不是200-299，也先查看响应内容
            if (!response.ok) {
              // 检查是否用户已创建但有其他警告
              // 如果响应包含id字段，说明用户可能已创建
              if (data.id || data.user || data.username) {
                console.log('用户可能已创建成功，但有其他警告:', data);
                messageElement.innerHTML = '<div class="alert alert-success">用户创建成功</div>';
                // 重置表单
                document.getElementById('createUserForm').reset();
                // 重新加载用户列表
                loadUserList();
                return data;
              }
              // 真正的错误
              throw data;
            }
            return data;
          });
        })
        .then(data => {
          console.log('用户创建成功数据:', data);
          messageElement.innerHTML = '<div class="alert alert-success">用户创建成功</div>';
          // 重置表单
          document.getElementById('createUserForm').reset();
          // 重新加载用户列表
          loadUserList();
        })
        .catch(error => {
          console.error('创建用户失败:', error);
          // 显示更友好的错误消息
          messageElement.innerHTML = `<div class="alert alert-danger">创建用户失败: ${typeof error === 'object' ? JSON.stringify(error) : error}</div>`;
        });
      }
      
      // 判断字符串是否包含中文字符
      function containsChinese(str) {
        return /[\u4e00-\u9fa5]/.test(str);
      }
      
      // 根据语言规则拼接姓名
      function formatFullName(firstName, lastName) {
        // 如果任一字段包含中文，则视为中文名（姓在前，名在后，无空格）
        if (containsChinese(firstName) || containsChinese(lastName)) {
          return (lastName || '') + (firstName || '');
        }
        // 否则视为英文名（名在前，姓在后，有空格）
        return `${firstName || ''} ${lastName || ''}`.trim();
      }
      
      // 加载用户列表
      function loadUserList() {
        const userListBody = document.getElementById('userListBody');
        const messageElement = document.getElementById('userListMessage');
        
        userListBody.innerHTML = '<tr><td colspan="8" class="text-center">加载中...</td></tr>';
        
        fetch('http://localhost:8000/api/users/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Token ${localStorage.getItem('userToken')}`
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('获取用户列表失败');
          }
          return response.json();
        })
        .then(users => {
          userListBody.innerHTML = '';
          
          if (users.length === 0) {
            userListBody.innerHTML = '<tr><td colspan="8" class="text-center">暂无用户</td></tr>';
            return;
          }
          
          users.forEach(user => {
            const fullName = formatFullName(user.first_name, user.last_name) || '-';
            const roleText = user.role === 'admin' ? '管理员' : '普通用户';
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${user.username}</td>
              <td>${user.email}</td>
              <td>${fullName}</td>
              <td>${roleText}</td>
              <td>${user.department || '-'}</td>
              <td>${user.position || '-'}</td>
              <td>${new Date(user.created_at).toLocaleString()}</td>
              <td>
                  <button class="btn btn-sm btn-primary mr-1" onclick="editUser(${user.id})">编辑</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">删除</button>
                </td>
            `;
            userListBody.appendChild(row);
          });
        })
        .catch(error => {
          console.error('加载用户列表失败:', error);
          userListBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载失败</td></tr>';
          messageElement.innerHTML = `<div class="alert alert-danger">获取用户列表失败: ${error.message}</div>`;
        });
      }
      
      // 编辑用户
      function editUser(userId) {
        // 验证用户权限
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        if (!userInfo || userInfo.role !== 'admin') {
          alert('您没有权限执行此操作');
          return;
        }
        
        // 存储当前编辑的用户ID并跳转到编辑页面
        localStorage.setItem('editingUserId', userId);
        switchPage('editUser');
      }
      
      // 加载用户详情进行编辑
      function loadUserForEdit(userId) {
        // 首先获取用户详情
        fetch(`http://localhost:8000/api/users/${userId}/`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Token ${localStorage.getItem('userToken')}`
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('获取用户详情失败');
          }
          return response.json();
        })
        .then(user => {
          // 填充表单
          document.getElementById('editUserId').value = user.id;
          document.getElementById('editUsername').value = user.username;
          document.getElementById('editEmail').value = user.email;
          document.getElementById('editFirstName').value = user.first_name || '';
          document.getElementById('editLastName').value = user.last_name || '';
          document.getElementById('editRole').value = user.role || 'user';
          document.getElementById('editRole').disabled = true; // 角色不可修改
          document.getElementById('editDepartment').value = user.department || '';
          document.getElementById('editPosition').value = user.position || '';
          document.getElementById('editPassword').value = '';
          document.getElementById('editUserMessage').innerHTML = '';
          
          // 更新页面标题
          document.getElementById('editUserPageTitle').textContent = `编辑用户: ${user.username}`;
        })
        .catch(error => {
          console.error('加载用户详情失败:', error);
          const messageElement = document.getElementById('editUserMessage');
          messageElement.innerHTML = `<div class="alert alert-danger">加载用户详情失败: ${error.message}</div>`;
        });
      }
      
      // 保存用户修改
      function saveUser() {
        // 验证用户权限
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        // 已经在上面声明过userId变量
        
        // 只有管理员可以编辑任何用户，普通用户只能编辑自己的资料
        if (!userInfo || (userInfo.role !== 'admin' && userInfo.id.toString() !== userId)) {
          alert('您没有权限执行此操作');
          return;
        }
        
        // 已经在上面声明过userId变量
        const username = document.getElementById('editUsername').value;
        const email = document.getElementById('editEmail').value;
        const firstName = document.getElementById('editFirstName').value;
        const lastName = document.getElementById('editLastName').value;
        const password = document.getElementById('editPassword').value;
        const department = document.getElementById('editDepartment').value;
        const position = document.getElementById('editPosition').value;
        
        const messageElement = document.getElementById('editUserMessage');
        
        // 表单验证
        if (!email.trim()) {
          messageElement.innerHTML = '<div class="alert alert-danger">邮箱不能为空</div>';
          return;
        }
        
        // 邮箱格式验证
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          messageElement.innerHTML = '<div class="alert alert-danger">请输入有效的邮箱地址</div>';
          return;
        }
        
        // 名字和姓氏不能为空
        if (!firstName.trim()) {
          messageElement.innerHTML = '<div class="alert alert-danger">名字不能为空</div>';
          return;
        }
        
        if (!lastName.trim()) {
          messageElement.innerHTML = '<div class="alert alert-danger">姓氏不能为空</div>';
          return;
        }
        
        // 构建更新数据（密码为空时不包含在更新数据中）
        // 必须包含username字段，因为后端序列化器要求它
        const userData = {
          username: username,  // 虽然是只读的，但后端要求包含此字段
          first_name: firstName,
          last_name: lastName,
          department,
          position
        };
        
        // 只有当密码不为空时才更新密码
        if (password) {
          userData.password = password;
        }
        
        console.log('发送到后端的数据:', userData);
        fetch(`http://localhost:8000/api/users/${userId}/`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Token ${localStorage.getItem('userToken')}`
          },
          body: JSON.stringify(userData)
        })
        .then(response => {
          console.log('响应状态:', response.status);
          if (!response.ok) {
            return response.json().then(err => {
              console.log('错误详情:', err);
              throw err;
            });
          }
          return response.json();
        })
        .then(data => {
          // 显示成功消息
          messageElement.innerHTML = '<div class="alert alert-success">用户更新成功</div>';
          
          // 3秒后返回用户列表
          setTimeout(() => {
            switchPage('userList');
          }, 1500);
        })
        .catch(error => {
          console.error('更新用户失败:', error);
          // 改进错误信息显示
          let errorMessage = '更新用户失败';
          if (error && typeof error === 'object') {
            if (error.email) {
              errorMessage = `更新用户失败: 邮箱${error.email}`;
            } else if (error.detail) {
              errorMessage = `更新用户失败: ${error.detail}`;
            } else {
              errorMessage = `更新用户失败: ${JSON.stringify(error)}`;
            }
          } else if (typeof error === 'string') {
            errorMessage = `更新用户失败: ${error}`;
          }
          messageElement.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
        });
      }
      
      // 删除用户
      function deleteUser(userId, username) {
        // 验证用户权限
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        if (!userInfo || userInfo.role !== 'admin') {
          alert('您没有权限执行此操作');
          return;
        }
        
        console.log('开始删除用户流程，用户ID:', userId, '用户名:', username);
        
        // 使用原生confirm对话框，确保确认逻辑正常工作
        const userConfirmed = confirm(`确定要删除用户 ${username} 吗？此操作不可撤销。`);
        console.log('用户确认结果:', userConfirmed);
        
        // 只有当用户明确点击确认时才执行删除
        if (userConfirmed) {
          console.log('用户已确认，准备发送删除请求');
          
          fetch(`http://localhost:8000/api/users/${userId}/`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Token ${localStorage.getItem('userToken')}`
            }
          })
          .then(response => {
            console.log('删除请求响应状态:', response.status);
            if (!response.ok) {
              throw new Error('删除用户失败');
            }
            // 重新加载用户列表
            console.log('删除成功，重新加载用户列表');
            loadUserList();
            // 显示成功消息
            const userListMessage = document.getElementById('userListMessage');
            userListMessage.innerHTML = '<div class="alert alert-success">用户删除成功</div>';
            setTimeout(() => {
              userListMessage.innerHTML = '';
            }, 3000);
          })
          .catch(error => {
            console.error('删除用户失败:', error);
            const userListMessage = document.getElementById('userListMessage');
            userListMessage.innerHTML = `<div class="alert alert-danger">删除用户失败: ${error.message}</div>`;
          });
        } else {
          console.log('用户取消了删除操作');
        }
      }
      
      // 页面切换时加载对应内容 - 已在前面定义
      
      // 页面加载时检查认证状态
      document.addEventListener('DOMContentLoaded', () => {
        checkAuthentication();
        
        // 绑定用户下拉菜单点击事件
        document.getElementById('userName').addEventListener('click', function(e) {
          e.stopPropagation(); // 阻止事件冒泡，避免点击菜单时关闭菜单
          toggleUserDropdown();
        });
        
        // 点击页面其他地方关闭下拉菜单
        document.addEventListener('click', function() {
          closeUserDropdown();
        });
        
        // 阻止点击下拉菜单项时关闭菜单（通过阻止事件冒泡）
        document.getElementById('userDropdownMenu').addEventListener('click', function(e) {
          e.stopPropagation();
        });
        
        // 绑定创建用户按钮事件
        const createUserBtn = document.getElementById('createUserBtn');
        if (createUserBtn) {
          createUserBtn.addEventListener('click', createUser);
        }
        
        // 表单提交事件（支持回车键）
        const createUserForm = document.getElementById('createUserForm');
        if (createUserForm) {
          createUserForm.addEventListener('submit', createUser);
        }
        
        // 绑定保存用户按钮点击事件
        document.getElementById('saveUserBtn').addEventListener('click', saveUser);
        
        // 处理下拉菜单点击事件
        const userManagementDropdown = document.getElementById('userManagementDropdown');
        if (userManagementDropdown) {
          userManagementDropdown.addEventListener('click', function(e) {
            e.preventDefault();
            // 只处理点击下拉按钮本身的情况，不处理点击下拉菜单项的情况
            if (e.target === this || !this.querySelector('.dropdown-menu').contains(e.target)) {
              const dropdownMenu = this.nextElementSibling;
              if (dropdownMenu) {
                dropdownMenu.classList.toggle('show');
                // 切换按钮的collapsed类来改变图标方向
                this.classList.toggle('collapsed');
              }
            }
          });
        }
        
        // 阻止点击下拉菜单项时关闭菜单
        document.querySelectorAll('.dropdown-item').forEach(item => {
          item.addEventListener('click', function(e) {
            // 不阻止事件传播，让switchPage函数正常执行
          });
        });
      });
    </script>
  </body>
</html>