# 微信小程序需求与设计澄清文档

## 1. 需求背景

### 1.1 项目概述

FreeArk微信小程序是FreeArk智能能源管理系统的移动端延伸，旨在为用户提供便捷的能源用量查询服务。用户无需登录，通过手机号验证即可绑定自己的居住单元，查询不同供能模式下的日用量、月用量及自定义时间段的用量统计。

### 1.2 业务目标

* 简化用户访问流程，无需注册登录即可使用核心功能

* 提供直观、便捷的能源用量查询界面

* 支持多种供能模式的用量数据展示

* 支持灵活的时间段查询

* 确保用户数据安全和隐私保护

## 2. 用户故事

| 编号 | 用户角色  | 故事描述                                   | 验收标准                                            |
| -- | ----- | -------------------------------------- | ----------------------------------------------- |
| 1  | 业主/住户 | 作为业主，我希望通过手机号快速绑定我的居住单元，以便查询能源用量       | 1. 手机号验证成功后可选择楼栋-单元-户号2. 绑定信息本地存储，下次访问无需重新绑定    |
| 2  | 业主/住户 | 作为业主，我希望查看当前供能模式下的日用量数据，以便了解每日能源消耗情况   | 1. 展示日用量趋势图2. 支持切换不同供能模式3. 显示详细的日用量数据列表         |
| 3  | 业主/住户 | 作为业主，我希望查看当前供能模式下的月用量数据，以便了解每月能源消耗情况   | 1. 展示月用量趋势图2. 支持切换不同供能模式3. 显示详细的月用量数据列表         |
| 4  | 业主/住户 | 作为业主，我希望查询自定义时间段内的能源用量统计，以便分析特定时期的消耗情况 | 1. 支持选择起始日期和结束日期2. 展示所选时间段内的总用量和趋势3. 支持切换不同供能模式 |
| 5  | 业主/住户 | 作为业主，我希望能够切换不同的供能模式，以便查看不同类型的能源用量      | 1. 提供供能模式切换选项2. 切换后实时更新相关数据展示                   |

## 3. 功能模块划分

### 3.1 核心功能模块

| 模块名称 | 功能描述                 | 包含页面                   |
| ---- | -------------------- | ---------------------- |
| 用户绑定 | 手机号验证、楼栋-单元-户号选择与绑定  | 绑定引导页、手机号验证页、单元选择页     |
| 用量查询 | 日用量查询、月用量查询、自定义时间段查询 | 首页、日用量页面、月用量页面、自定义查询页面 |
| 数据展示 | 图表展示、数据列表展示、供能模式切换   | 数据展示组件、图表组件、供能模式选择组件   |
| 系统设置 | 绑定信息管理、关于我们、帮助中心     | 设置页面                   |

### 3.2 功能详细说明

#### 3.2.1 用户绑定模块

* **手机号验证**：通过短信验证码验证用户手机号真实性

* **楼栋-单元-户号绑定: 通过微信手机号访问后台服务，定制绑定到手机号所匹配的楼栋-单元-户号**

* **绑定信息存储**：绑定时在freearkweb创建普通用户，支持一键解绑和重新绑定

#### 3.2.2 用量查询模块

* **日用量查询**：展示选定供能模式下的每日能源用量数据

* **月用量查询**：展示选定供能模式下的每月能源用量数据

* **自定义时间段查询**：支持用户选择任意起始和结束日期，查询该时间段内的能源用量

#### 3.2.3 数据展示模块

* **图表展示**：使用折线图展示用量趋势

* **数据列表**：详细列出每日/每月的用量数据

* **供能模式切换**：支持切换不同的供能模式，实时更新数据

## 4. 界面原型描述

### 4.1 页面流程图

```
启动小程序 → 检查本地绑定信息 → 绑定引导页/首页
  ↓
绑定引导页 → 手机号验证页 → 单元选择页 → 首页
  ↓
首页 → 日用量页面/月用量页面/自定义查询页面/设置页面
  ↓
设置页面 → 绑定信息管理/关于我们/帮助中心
```

### 4.2 主要页面设计

#### 4.2.1 绑定引导页

* 页面标题：欢迎使用FreeArk

* 主要内容：小程序介绍、功能亮点

* 操作按钮："开始使用"按钮，跳转到手机号验证页

#### 4.2.2 手机号验证页

* 页面标题：手机号验证

* 主要内容：手机号输入框、验证码输入框、获取验证码按钮

* 操作按钮："下一步"按钮，验证成功后跳转到单元选择页

#### 4.2.3 单元选择页

* 页面标题：住户绑定

* 主要内容：访问后台服务，根据手机号匹配的信息显示对应可以绑定的楼栋-单元-户号 （注意存在一个手机号的业主可能拥有多套房产）

* 操作按钮："绑定"按钮，绑定成功后跳转到首页

#### 4.2.4 首页

* 页面标题：FreeArk

* 主要内容：

  * 绑定信息展示（当前绑定的楼栋-单元-户号）可以切换到多个人绑定的住宅

  * 供能模式选择器

  * 快捷入口（日用量、月用量、自定义查询）

  * 最新用量数据概览

* 操作按钮：各功能模块入口按钮

#### 4.2.5 日用量页面

* 页面标题：日用量查询

* 主要内容：

  * 供能模式选择器

  * 日期选择器（可选，默认展示最近7天）

  * 日用量趋势图

  * 日用量数据列表

#### 4.2.6 月用量页面

* 页面标题：月用量查询

* 主要内容：

  * 供能模式选择器

  * 月份选择器（可选，默认展示最近6个月）

  * 月用量趋势图

  * 月用量数据列表

#### 4.2.7 自定义查询页面

* 页面标题：自定义查询

* 主要内容：

  * 供能模式选择器

  * 起始日期选择器

  * 结束日期选择器

  * 查询按钮

  * 查询结果展示（总用量、趋势图、数据列表）

#### 4.2.8 设置页面

* 页面标题：设置

* 主要内容：

  * 当前绑定信息展示

  * 解绑按钮

  * 重新绑定按钮

  * 关于我们

  * 帮助中心

## 5. 数据流转流程

### 5.1 数据获取流程

```
用户选择查询条件 → 小程序前端构造请求 → 调用后端API → 后端查询数据库 → 返回JSON数据 → 前端解析数据 → 渲染页面
```

### 5.2 关键数据实体

#### 5.2.1 绑定信息

```json
{
  "phone": "13800138000",
  "building": "1#",
  "unit": "1单元",
  "room_number": "101",
  "bind_time": "2024-01-01T12:00:00Z"
}
```

#### 5.2.2 日用量数据

```json
{
  "time_period": "2024-01-01",
  "energy_mode": "heating",
  "usage_quantity": 12.5,
  "building": "1#",
  "unit": "1单元",
  "room_number": "101"
}
```

#### 5.2.3 月用量数据

```json
{
  "usage_month": "2024-01",
  "energy_mode": "heating",
  "usage_quantity": 375.0,
  "building": "1#",
  "unit": "1单元",
  "room_number": "101"
}
```

## 6. 接口调用规范

### 6.1 后端API基础信息

| 项        | 值                            |
| -------- | ---------------------------- |
| API基础URL | <http://localhost:8000/api/> |
| 请求方式     | GET                          |
| 数据格式     | JSON                         |

### 6.2 核心API接口

#### 6.2.1 获取日用量数据

* **接口URL**：`/api/get_usage_quantity/`

* **请求参数**：

  * `specific_part`：特定部分标识（可选）

  * `energy_mode`：供能模式（必填）

  * `start_time`：起始时间（格式：YYYY-MM-DD，可选）

  * `end_time`：结束时间（格式：YYYY-MM-DD，可选）

  * `page`：页码（可选，默认1）

  * `page_size`：每页条数（可选，默认20）

#### 6.2.2 获取月度用量数据

* **接口URL**：`/api/get_usage_quantity_monthly/`

* **请求参数**：

  * `building`：楼栋（必填）

  * `unit`：单元（必填）

  * `room_number`：房号（必填）

  * `energy_mode`：供能模式（必填）

  * `usage_month`：用量月份（格式：YYYY-MM，可选）

  * `start_month`：起始月份（格式：YYYY-MM，可选）

  * `end_month`：结束月份（格式：YYYY-MM，可选）

  * `page`：页码（可选，默认1）

  * `page_size`：每页条数（可选，默认10）

#### 6.2.3 获取自定义时间段用量数据

* **接口URL**：`/api/get_usage_quantity_specific_time_period/`

* **请求参数**：

  * `specific_part`：特定部分标识（可选）

  * `energy_mode`：供能模式（必填）

  * `start_time`：起始时间（格式：YYYY-MM-DD，必填）

  * `end_time`：结束时间（格式：YYYY-MM-DD，必填）

  * `page`：页码（可选，默认1）

  * `page_size`：每页条数（可选，默认20）

### 6.3 接口调用示例

```javascript
// 获取日用量数据示例
wx.request({
  url: 'http://localhost:8000/api/get_usage_quantity/',
  method: 'GET',
  data: {
    building: '1#',
    unit: '1单元',
    room_number: '101',
    energy_mode: 'heating',
    start_time: '2024-01-01',
    end_time: '2024-01-07'
  },
  success: (res) => {
    console.log(res.data);
  },
  fail: (err) => {
    console.error(err);
  }
});
```

## 7. 安全考虑因素

### 7.1 数据安全

* 所有API请求使用HTTPS协议传输

* 敏感数据（如手机号）在本地存储时进行加密处理

* 定期清理本地存储的临时数据

### 7.2 隐私保护

* 明确告知用户数据收集范围和用途

* 不收集与核心功能无关的用户数据

* 提供数据解绑和删除功能

### 7.3 接口安全

* 后端API实现了请求频率限制，防止恶意请求

* 对敏感操作（如数据查询）进行必要的参数校验

* 定期更新API密钥和认证机制

## 8. 开发里程碑计划

### 8.1 第一阶段：需求确认与设计（1周）

* 完成需求分析和澄清

* 确定技术栈和架构设计

* 完成UI/UX设计

* 制定详细的开发计划

### 8.2 第二阶段：核心功能开发（2周）

* 搭建小程序项目框架

* 实现用户绑定功能

* 实现数据查询功能

* 实现图表展示功能

### 8.3 第三阶段：测试与优化（1周）

* 进行功能测试

* 进行性能测试

* 修复bug和优化用户体验

* 完成文档编写

### 8.4 第四阶段：上线准备与发布（1周）

* 准备上线材料

* 提交小程序审核

* 审核通过后正式发布

* 收集用户反馈并持续优化

## 9. 技术栈选择

### 9.1 前端技术

* 微信小程序原生开发

* WXML + WXSS + JavaScript

* ECharts for Weixin（图表库）

### 9.2 后端技术

* 现有FreeArkWeb后端API

* Django REST Framework

### 9.3 数据存储

* 小程序本地存储（绑定信息）

* 后端数据库（用量数据）

## 10. 依赖关系

* 依赖现有FreeArkWeb后端API的稳定性和可用性

* 依赖后端数据库中用量数据的准确性和完整性

* 依赖微信小程序平台的政策和技术规范

## 11. 风险评估

| 风险项        | 影响程度 | 可能性 | 应对措施                   |
| ---------- | ---- | --- | ---------------------- |
| 后端API不稳定   | 高    | 中   | 实现API请求重试机制，添加友好的错误提示  |
| 数据更新不及时    | 中    | 中   | 明确告知用户数据更新频率，添加数据更新时间戳 |
| 微信小程序审核不通过 | 高    | 低   | 严格遵守微信小程序开发规范，提前准备审核材料 |
| 用户绑定信息错误   | 中    | 高   | 提供便捷的重新绑定功能，添加绑定信息验证机制 |

## 12. 验收标准

### 12.1 功能验收

* 所有核心功能正常工作

* 用户绑定流程顺畅

* 数据查询结果准确

* 图表展示清晰直观

### 12.2 性能验收

* 页面加载时间不超过2秒

* API请求响应时间不超过1秒

* 小程序启动时间不超过3秒

### 12.3 兼容性验收

* 支持微信小程序基础库2.10.0及以上版本

* 兼容主流手机机型和系统版本

* 适配不同屏幕尺寸

### 12.4 用户体验验收

* 界面设计简洁美观

* 操作流程直观易懂

* 错误提示友好明确

* 提供必要的帮助和引导信息

## 13. 后续迭代计划

* 增加用量数据对比功能

* 增加用量预警功能

* 增加多单元绑定功能

* 增加数据导出功能

* 增加个性化推荐功能

# 附录

## 附录A：供能模式说明

| 供能模式        | 说明   |
| ----------- | ---- |
| heating     | 供暖模式 |
| cooling     | 制冷模式 |
| hot_water  | 热水模式 |
| electricity | 电力模式 |

## 附录B：数据格式说明

### B.1 日用量数据格式

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "time_period": "2024-01-01T00:00:00Z",
      "energy_mode": "heating",
      "usage_quantity": 12.5,
      "building": "1#",
      "unit": "1单元",
      "room_number": "101"
    }
  ],
  "total": 7
}
```

### B.2 月度用量数据格式

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "usage_month": "2024-01",
      "energy_mode": "heating",
      "usage_quantity": 375.0,
      "building": "1#",
      "unit": "1单元",
      "room_number": "101"
    }
  ],
  "total": 12
}
```

### B.3 自定义时间段用量数据格式

```json
{
  "success": true,
  "data": [
    {
      "specific_part": "1#-1单元-101",
      "building": "1#",
      "unit": "1单元",
      "room_number": "101",
      "energy_mode": "heating",
      "initial_energy": 100.0,
      "final_energy": 200.0,
      "usage_quantity": 100.0,
      "time_period": "2024-01-01 至 2024-01-31"
    }
  ],
  "total": 1
}
```

